# Redis 三大集群模式

![](static/images/redis/redis-cluster.png)

## Redis集群简介

### 什么是Redis集群

Redis集群是一种通过将多个Redis节点连接在一起以实现高可用性、数据分片和负载均衡的技术。它允许Redis在不同节点上同时提供服务，提高整体性能和可靠性。

根据搭建的方式和集群的特性，Redis集群主要有三种模式

1. 主从复制模式（Master-Slave）
2. 哨兵模式（Sentinel）
3. Cluster模式。

### Redis集群的作用和优势

1. 高可用性：Redis集群可以在某个节点发生故障时，自动进行故障转移，保证服务的持续可用。
2. 负载均衡：Redis集群可以将客户端请求分发到不同的节点上，有效地分摊节点的压力，提高系统的整体性能。
3. 容灾恢复：通过主从复制或哨兵模式，Redis集群可以在主节点出现故障时，快速切换到从节点，实现业务的无缝切换。
4. 数据分片：在Cluster模式下，Redis集群可以将数据分散在不同的节点上，从而突破单节点内存限制，实现更大规模的数据存储。
5. 易于扩展：Redis集群可以根据业务需求和系统负载，动态地添加或移除节点，实现水平扩展。

## 主从复制模式（Master-Slave）

### 主从复制原理

主从复制是Redis的一种基本集群模式，它通过将一个Redis节点（主节点）的数据复制到一个或多个其他Redis节点（从节点）来实现数据的冗余和备份。

主节点负责处理客户端的写操作，同时从节点会实时同步主节点的数据。客户端可以从从节点读取数据，实现读写分离，提高系统性能。

![](static/images/redis/734446-20230423104604712-958561171.png)

### 主从复制配置和实现

配置主节点：在主节点的redis.conf配置文件中，无需进行特殊配置，主节点默认监听所有客户端请求。

```bash
# 主节点默认端口号6379
port 6379
```

配置从节点：在从节点的redis.conf配置文件中，添加如下配置，指定主节点的地址和端口：

```bash
# 从节点设置端口号6380
port 6380

# replicaof 主节点IP 主节点端口
replicaof 127.0.0.1 6379
```

或者，通过Redis命令行在从节点上执行如下命令：

```bash
redis> replicaof 127.0.0.1 6379
```

验证主从复制：在主节点上执行写操作，然后在从节点上进行读操作，检查数据是否一致。

### 主从复制的优缺点

优点：

1. 配置简单，易于实现。
2. 实现数据冗余，提高数据可靠性。
3. 读写分离，提高系统性能。

缺点：

1. 主节点故障时，需要手动切换到从节点，故障恢复时间较长。
2. 主节点承担所有写操作，可能成为性能瓶颈。
3. 无法实现数据分片，受单节点内存限制。

### 主从复制场景应用

主从复制模式适用于以下场景：

1. 数据备份和容灾恢复：通过从节点备份主节点的数据，实现数据冗余。
2. 读写分离：将读操作分发到从节点，减轻主节点压力，提高系统性能。
3. 在线升级和扩展：在不影响主节点的情况下，通过增加从节点来扩展系统的读取能力。

> 总结：主从复制模式适合数据备份、读写分离和在线升级等场景，但在主节点故障时需要手动切换，不能自动实现故障转移。如果对高可用性要求较高，可以考虑使用哨兵模式或Cluster模式。

## 哨兵模式（Sentinel）

### 哨兵模式原理

哨兵模式是在主从复制基础上加入了哨兵节点，实现了自动故障转移。哨兵节点是一种特殊的Redis节点，它会监控主节点和从节点的运行状态。当主节点发生故障时，哨兵节点会自动从从节点中选举出一个新的主节点，并通知其他从节点和客户端，实现故障转移。

![](static/images/redis/734446-20230423104619091-219085123.png)

### 哨兵模式配置和实现

配置主从复制：首先按照主从复制模式的配置方法，搭建一个主从复制集群（上面已经讲过）。

配置哨兵节点：在哨兵节点上创建一个新的哨兵配置文件（如：sentinel.conf），并添加如下配置：

```bash
# sentinel节点端口号
port 26379

# sentinel monitor 被监控主节点名称 主节点IP 主节点端口 quorum
sentinel monitor mymaster 127.0.0.1 6379 2

# sentinel down-after-milliseconds 被监控主节点名称 毫秒数
sentinel down-after-milliseconds mymaster 60000

# sentinel failover-timeout 被监控主节点名称 毫秒数
sentinel failover-timeout mymaster 180000
```

其中，quorum是指触发故障转移所需的最小哨兵节点数。down-after-milliseconds表示主节点被判断为失效的时间。failover-timeout是故障转移超时时间。

> 为什么只配置了sentinel监控主节点，没有配置监控从节点？
>
> 因为通过主节点，就可以找到从节点。

启动哨兵节点：使用如下命令启动哨兵节点：

```bash
redis> redis-sentinel /path/to/sentinel.conf
```

验证哨兵模式：手动停止主节点，观察哨兵节点是否自动选举出新的主节点，并通知其他从节点和客户端。

### 哨兵模式的优缺点

优点：

1. 自动故障转移，提高系统的高可用性。
2. 具有主从复制模式的所有优点，如数据冗余和读写分离。

缺点：

1. 配置和管理相对复杂。
2. 依然无法实现数据分片，受单节点内存限制。

### 哨兵模式场景应用

1. 高可用性要求较高的场景：通过自动故障转移，确保服务的持续可用。
2. 数据备份和容灾恢复：在主从复制的基础上，提供自动故障转移功能。

> 总结：哨兵模式在主从复制模式的基础上实现了自动故障转移，提高了系统的高可用性。然而，它仍然无法实现数据分片。如果需要实现数据分片和负载均衡，可以考虑使用Cluster模式。

## Cluster模式

### Cluster模式原理

Cluster模式是Redis的一种高级集群模式，它通过数据分片和分布式存储实现了负载均衡和高可用性。在Cluster模式下，Redis将所有的键值对数据分散在多个节点上。每个节点负责一部分数据，称为槽位。通过对数据的分片，Cluster模式可以突破单节点的内存限制，实现更大规模的数据存储。

![](static/images/redis/734446-20230423104631153-1328078427.png)

### 数据分片与槽位

Redis Cluster将数据分为16384个槽位，每个节点负责管理一部分槽位。当客户端向Redis Cluster发送请求时，Cluster会根据键的哈希值将请求路由到相应的节点。具体来说，Redis Cluster使用CRC16算法计算键的哈希值，然后对16384取模，得到槽位编号。

### Cluster模式配置和实现

配置Redis节点：为每个节点创建一个redis.conf配置文件，并添加如下配置：

```bash
# cluster节点端口号
port 7001

# 开启集群模式
cluster-enabled yes

# 节点超时时间
cluster-node-timeout 15000
```

像这样的配置，一共需要创建6个，我们做一个三主三从的集群。

启动Redis节点：使用如下命令启动6个节点：

```bash
redis> redis-server redis_7001.conf
```

创建Redis Cluster：使用Redis命令行工具执行如下命令创建Cluster：

```bash
redis> redis-cli --cluster create 127.0.0.1:7001 127.0.0.1:7002 127.0.0.1:7003 127.0.0.1:7004 127.0.0.1:7005 127.0.0.1:7006 --cluster-replicas 1
```

cluster-replicas 表示从节点的数量，1代表每个主节点都有一个从节点。

验证Cluster模式：向Cluster发送请求，观察请求是否正确路由到相应的节点。

### Cluster模式的优缺点

优点：

1. 数据分片，实现大规模数据存储。
2. 负载均衡，提高系统性能。
3. 自动故障转移，提高高可用性。

缺点：

1. 配置和管理较复杂。
2. 一些复杂的多键操作可能受到限制。

### Cluster模式场景应用

1. 大规模数据存储：通过数据分片，突破单节点内存限制。
2. 高性能要求场景：通过负载均衡，提高系统性能。
3. 高可用性要求场景：通过自动故障转移，确保服务的持续可用。

> 总结：Cluster模式在提供高可用性的同时，实现了数据分片和负载均衡，适用于大规模数据存储和高性能要求的场景。然而，它的配置和管理相对复杂，且某些复杂的多键操作可能受到限制。

## 总结

1. 主从复制模式：适用于数据备份和读写分离场景，配置简单，但在主节点故障时需要手动切换。
2. 哨兵模式：在主从复制的基础上实现自动故障转移，提高高可用性，适用于高可用性要求较高的场景。
3. Cluster模式：通过数据分片和负载均衡实现大规模数据存储和高性能，适用于大规模数据存储和高性能要求场景。

> 在实际应用中，可以根据系统的需求和特点选择合适的Redis集群模式，以实现高可用性、高性能和大规模数据存储。