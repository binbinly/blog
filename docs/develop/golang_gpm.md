# Goè¯­è¨€çš„GPMè°ƒåº¦å™¨æ˜¯ä»€ä¹ˆï¼Ÿ

ç›¸ä¿¡å¾ˆå¤šäººéƒ½å¬è¯´è¿‡Goè¯­è¨€å¤©ç„¶æ”¯æŒé«˜å¹¶å‘ï¼ŒåŸå› æ˜¯å†…éƒ¨æœ‰åç¨‹ï¼ˆgoroutineï¼‰åŠ æŒï¼Œå¯ä»¥åœ¨ä¸€ä¸ªè¿›ç¨‹ä¸­å¯åŠ¨æˆåƒä¸Šä¸‡ä¸ªåç¨‹ã€‚é‚£ä¹ˆï¼Œå®ƒå‡­ä»€ä¹ˆåšåˆ°å¦‚æ­¤é«˜çš„å¹¶å‘å‘¢ï¼Ÿé‚£å°±éœ€è¦å…ˆäº†è§£ä»€ä¹ˆæ˜¯å¹¶å‘æ¨¡å‹ã€‚

## å¹¶å‘æ¨¡å‹

è‘—åçš„C++ä¸“å®¶Herb Sutteræ›¾ç»è¯´è¿‡â€œå…è´¹çš„åˆé¤å·²ç»ç»ˆç»“â€ã€‚ä¸ºäº†è®©ä»£ç è¿è¡Œçš„æ›´å¿«ï¼Œå•çº¯ä¾é æ›´å¿«çš„ç¡¬ä»¶å·²ç»æ— æ³•å¾—åˆ°æ»¡è¶³ï¼Œæˆ‘ä»¬éœ€è¦åˆ©ç”¨å¤šæ ¸æ¥æŒ–æ˜å¹¶è¡Œçš„ä»·å€¼ï¼Œè€Œå¹¶å‘æ¨¡å‹çš„ç›®çš„å°±æ˜¯æ¥å‘Šè¯‰ä½ ä¸åŒæ‰§è¡Œå®ä½“ä¹‹é—´æ˜¯å¦‚ä½•åä½œçš„ã€‚

å½“ç„¶ï¼Œä¸åŒçš„å¹¶å‘æ¨¡å‹çš„åä½œæ–¹å¼ä¹Ÿä¸å°½ç›¸åŒï¼Œå¸¸è§çš„å¹¶å‘æ¨¡å‹æœ‰ä¸ƒç§ï¼š

- çº¿ç¨‹ä¸é”
- å‡½æ•°å¼ç¼–ç¨‹
- Clojureä¹‹é“
- actor
- é€šè®¯é¡ºåºè¿›ç¨‹ï¼ˆCSPï¼‰
- æ•°æ®çº§å¹¶è¡Œ
- Lambdaæ¶æ„

è€Œä»Šå¤©ï¼Œæˆ‘ä»¬åªè®²ä¸Goè¯­è¨€ç›¸å…³çš„å¹¶å‘æ¨¡å‹CSPï¼Œæ„Ÿå…´è¶£çš„åŒå­¦å¯ä»¥è‡ªè¡ŒæŸ¥é˜…ä¹¦ç±ã€Šä¸ƒå‘¨ä¸ƒå¹¶å‘æ¨¡å‹ã€‹ã€‚

### CSPç¯‡

CSPï¼Œå…¨ç§°Communicating Sequential Processesï¼Œæ„ä¸ºé€šè®¯é¡ºåºè¿›ç¨‹ï¼Œå®ƒæ˜¯ä¸ƒå¤§å¹¶å‘æ¨¡å‹ä¸­çš„ä¸€ç§ï¼Œå®ƒçš„æ ¸å¿ƒè§‚å¿µæ˜¯å°†ä¸¤ä¸ªå¹¶å‘æ‰§è¡Œçš„å®ä½“é€šè¿‡é€šé“channelè¿æ¥èµ·æ¥ï¼Œæ‰€æœ‰çš„æ¶ˆæ¯éƒ½é€šè¿‡channelä¼ è¾“ã€‚å…¶å®CSPæ¦‚å¿µæ—©åœ¨1978å¹´å°±è¢«ä¸œå°¼Â·éœå°”æå‡ºï¼Œç”±äºè¿‘æ¥Goè¯­è¨€çš„å…´èµ·ï¼ŒCSPåˆç«äº†èµ·æ¥ã€‚
é‚£ä¹ˆCSPä¸Goè¯­è¨€æœ‰ä»€ä¹ˆå…³ç³»å‘¢ï¼Ÿæ¥ä¸‹æ¥æˆ‘ä»¬æ¥çœ‹Goè¯­è¨€å¯¹CSPå¹¶å‘æ¨¡å‹çš„å®ç°â€”â€”GPMè°ƒåº¦æ¨¡å‹ã€‚

### GPMè°ƒåº¦æ¨¡å‹

GPMä»£è¡¨äº†ä¸‰ä¸ªè§’è‰²ï¼Œåˆ†åˆ«æ˜¯Goroutineã€Processorã€Machineã€‚

- Goroutineï¼šå°±æ˜¯å’±ä»¬å¸¸ç”¨çš„ç”¨goå…³é”®å­—åˆ›å»ºçš„æ‰§è¡Œä½“ï¼Œå®ƒå¯¹åº”ä¸€ä¸ªç»“æ„ä½“gï¼Œç»“æ„ä½“é‡Œä¿å­˜äº†goroutineçš„å †æ ˆä¿¡æ¯
- Machineï¼šè¡¨ç¤ºæ“ä½œç³»ç»Ÿçš„çº¿ç¨‹
- Processorï¼šè¡¨ç¤ºå¤„ç†å™¨ï¼Œæœ‰äº†å®ƒæ‰èƒ½å»ºç«‹Gã€Mçš„è”ç³»

### Goroutine

Goroutineå°±æ˜¯ä»£ç ä¸­ä½¿ç”¨goå…³é”®è¯åˆ›å»ºçš„æ‰§è¡Œå•å…ƒï¼Œä¹Ÿæ˜¯å¤§å®¶ç†ŸçŸ¥çš„æœ‰â€œè½»é‡çº§çº¿ç¨‹â€ä¹‹ç§°çš„åç¨‹ï¼Œåç¨‹æ˜¯ä¸ä¸ºæ“ä½œç³»ç»Ÿæ‰€çŸ¥çš„ï¼Œå®ƒç”±ç¼–ç¨‹è¯­è¨€å±‚é¢å®ç°ï¼Œä¸Šä¸‹æ–‡åˆ‡æ¢ä¸éœ€è¦ç»è¿‡å†…æ ¸æ€ï¼Œå†åŠ ä¸Šåç¨‹å ç”¨çš„å†…å­˜ç©ºé—´æå°ï¼Œæ‰€ä»¥æœ‰ç€éå¸¸å¤§çš„å‘å±•æ½œåŠ›ã€‚

```go
go func() {}()
```

å¤åˆ¶ä»£ç åœ¨Goè¯­è¨€ä¸­ï¼ŒGoroutineç”±ä¸€ä¸ªåä¸ºruntime.goçš„ç»“æ„ä½“è¡¨ç¤ºï¼Œè¯¥ç»“æ„ä½“éå¸¸å¤æ‚ï¼Œæœ‰40å¤šä¸ªæˆå‘˜å˜é‡ï¼Œä¸»è¦å­˜å‚¨æ‰§è¡Œæ ˆã€çŠ¶æ€ã€å½“å‰å ç”¨çš„çº¿ç¨‹ã€è°ƒåº¦ç›¸å…³çš„æ•°æ®ã€‚è¿˜æœ‰ç©å¤§å®¶å¾ˆæƒ³è·å–çš„goroutineæ ‡è¯†ï¼Œä½†æ˜¯å¾ˆæŠ±æ­‰ï¼Œå®˜æ–¹è€ƒè™‘åˆ°Goè¯­è¨€çš„å‘å±•ï¼Œè®¾ç½®æˆç§æœ‰äº†ï¼Œä¸ç»™ä½ è°ƒç”¨ğŸ˜ã€‚

```go
type g struct {
	stack struct {
		lo uintptr
		hi uintptr
	} 							// æ ˆå†…å­˜ï¼š[stack.lo, stack.hi)
	stackguard0	uintptr
	stackguard1 uintptr

	_panic       *_panic
	_defer       *_defer
	m            *m				// å½“å‰çš„ m
	sched        gobuf
	stktopsp     uintptr		// æœŸæœ› sp ä½äºæ ˆé¡¶ï¼Œç”¨äºå›æº¯æ£€æŸ¥
	param        unsafe.Pointer // wakeup å”¤é†’æ—¶å€™ä¼ é€’çš„å‚æ•°
	atomicstatus uint32
	goid         int64
	preempt      bool       	// æŠ¢å ä¿¡å·ï¼Œstackguard0 = stackpreempt çš„å‰¯æœ¬
	timer        *timer         // ä¸º time.Sleep ç¼“å­˜çš„è®¡æ—¶å™¨

	...
}
```
Goroutineè°ƒåº¦ç›¸å…³çš„æ•°æ®å­˜å‚¨åœ¨schedï¼Œåœ¨åç¨‹åˆ‡æ¢ã€æ¢å¤ä¸Šä¸‹æ–‡çš„æ—¶å€™ç”¨åˆ°ã€‚

```go
type gobuf struct {
	sp   uintptr
	pc   uintptr
	g    guintptr
	ret  sys.Uintreg
	...
}
```

Må°±æ˜¯å¯¹åº”æ“ä½œç³»ç»Ÿçš„çº¿ç¨‹ï¼Œæœ€å¤šä¼šæœ‰GOMAXPROCSä¸ªæ´»è·ƒçº¿ç¨‹èƒ½å¤Ÿæ­£å¸¸è¿è¡Œï¼Œé»˜è®¤æƒ…å†µä¸‹GOMAXPROCSè¢«è®¾ç½®ä¸ºå†…æ ¸æ•°ï¼Œå‡å¦‚æœ‰å››ä¸ªå†…æ ¸ï¼Œé‚£ä¹ˆé»˜è®¤å°±åˆ›å»ºå››ä¸ªçº¿ç¨‹ï¼Œæ¯ä¸€ä¸ªçº¿ç¨‹å¯¹åº”ä¸€ä¸ªruntime.mç»“æ„ä½“ã€‚çº¿ç¨‹æ•°ç­‰äºCPUä¸ªæ•°çš„åŸå› æ˜¯ï¼Œæ¯ä¸ªçº¿ç¨‹åˆ†é…åˆ°ä¸€ä¸ªCPUä¸Šå°±ä¸è‡³äºå‡ºç°çº¿ç¨‹çš„ä¸Šä¸‹æ–‡åˆ‡æ¢ï¼Œå¯ä»¥ä¿è¯ç³»ç»Ÿå¼€é”€é™åˆ°æœ€ä½ã€‚

```go
type m struct {
	g0   *g 
	curg *g
	...
}
```

Mé‡Œé¢å­˜äº†ä¸¤ä¸ªæ¯”è¾ƒé‡è¦çš„ä¸œè¥¿ï¼Œä¸€ä¸ªæ˜¯g0ï¼Œä¸€ä¸ªæ˜¯curgã€‚

- g0ï¼šä¼šæ·±åº¦å‚ä¸è¿è¡Œæ—¶çš„è°ƒåº¦è¿‡ç¨‹ï¼Œæ¯”å¦‚goroutineçš„åˆ›å»ºã€å†…å­˜åˆ†é…ç­‰
- curgï¼šä»£è¡¨å½“å‰æ­£åœ¨çº¿ç¨‹ä¸Šæ‰§è¡Œçš„goroutineã€‚

åˆšæ‰è¯´Pæ˜¯è´Ÿè´£Mä¸Gçš„å…³è”ï¼Œæ‰€ä»¥Mé‡Œé¢è¿˜è¦å­˜å‚¨ä¸Pç›¸å…³çš„æ•°æ®ã€‚

```go
type m struct {
  ...
	p             puintptr
	nextp         puintptr
	oldp          puintptr
}
```

- pï¼šæ­£åœ¨è¿è¡Œä»£ç çš„å¤„ç†å™¨
- nextpï¼šæš‚å­˜çš„å¤„ç†å™¨
- oldpï¼šç³»ç»Ÿè°ƒç”¨ä¹‹å‰çš„çº¿ç¨‹çš„å¤„ç†å™¨

### Processor

Proccessorè´Ÿè´£Machineä¸Goroutineçš„è¿æ¥ï¼Œå®ƒèƒ½æä¾›çº¿ç¨‹éœ€è¦çš„ä¸Šä¸‹æ–‡ç¯å¢ƒï¼Œä¹Ÿèƒ½åˆ†é…Gåˆ°å®ƒåº”è¯¥å»çš„çº¿ç¨‹ä¸Šæ‰§è¡Œï¼Œæœ‰äº†å®ƒï¼Œæ¯ä¸ªGéƒ½èƒ½å¾—åˆ°åˆç†çš„è°ƒç”¨ï¼Œæ¯ä¸ªçº¿ç¨‹éƒ½ä¸å†æµ‘æ°´æ‘¸é±¼ï¼ŒçœŸæ˜¯å±…å®¶å¿…å¤‡ä¹‹è‰¯å“ã€‚

åŒæ ·çš„ï¼Œå¤„ç†å™¨çš„æ•°é‡ä¹Ÿæ˜¯é»˜è®¤æŒ‰ç…§GOMAXPROCSæ¥è®¾ç½®çš„ï¼Œä¸çº¿ç¨‹çš„æ•°é‡ä¸€ä¸€å¯¹åº”ã€‚

```go
type p struct {
	m           muintptr

	runqhead uint32
	runqtail uint32
	runq     [256]guintptr
	runnext guintptr
	...
}
```

ç»“æ„ä½“Pä¸­å­˜å‚¨äº†æ€§èƒ½è¿½è¸ªã€åƒåœ¾å›æ”¶ã€è®¡æ—¶å™¨ç­‰ç›¸å…³çš„å­—æ®µå¤–ï¼Œè¿˜å­˜å‚¨äº†å¤„ç†å™¨çš„å¾…è¿è¡Œé˜Ÿåˆ—ï¼Œé˜Ÿåˆ—ä¸­å­˜å‚¨çš„æ˜¯å¾…æ‰§è¡Œçš„Goroutineåˆ—è¡¨ã€‚

### ä¸‰è€…çš„å…³ç³»

é¦–å…ˆï¼Œé»˜è®¤å¯åŠ¨å››ä¸ªçº¿ç¨‹å››ä¸ªå¤„ç†å™¨ï¼Œç„¶åäº’ç›¸ç»‘å®šã€‚

![](static/images/17188139b47a27ca.jpg)

è¿™ä¸ªæ—¶å€™ï¼Œä¸€ä¸ªGoroutineç»“æ„ä½“è¢«åˆ›å»ºï¼Œåœ¨è¿›è¡Œå‡½æ•°ä½“åœ°å€ã€å‚æ•°èµ·å§‹åœ°å€ã€å‚æ•°é•¿åº¦ç­‰ä¿¡æ¯ä»¥åŠè°ƒåº¦ç›¸å…³å±æ€§æ›´æ–°ä¹‹åï¼Œå®ƒå°±è¦è¿›åˆ°ä¸€ä¸ªå¤„ç†å™¨çš„é˜Ÿåˆ—ç­‰å¾…å‘è½¦ã€‚

![](static/images/17188139f32b2558.jpg)

å•¥ï¼Œåˆåˆ›å»ºäº†ä¸€ä¸ªGï¼Ÿé‚£å°±è½®æµå¾€å…¶ä»–Pé‡Œé¢æ”¾å‘—ï¼Œç›¸ä¿¡ä½ æ’é˜Ÿå–å·çš„æ—¶å€™çœ‹åˆ°å…¶ä»–çª—å£æ²¡äººæ’é˜Ÿä¹Ÿä¼šè¿‡å»çš„ã€‚

![](static/images/1718813a3359a1c0.jpg)

å‡å¦‚æœ‰å¾ˆå¤šGï¼Œéƒ½å¡æ»¡äº†æ€ä¹ˆåŠå‘¢ï¼Ÿé‚£å°±ä¸æŠŠGå¡åˆ°å¤„ç†å™¨çš„ç§æœ‰é˜Ÿåˆ—é‡Œäº†ï¼Œè€Œæ˜¯æŠŠå®ƒå¡åˆ°å…¨å±€é˜Ÿåˆ—é‡Œï¼ˆå€™è½¦å¤§å…ï¼‰ã€‚

![](static/images/1718813a71f700a1.jpg)

é™¤äº†å¾€é‡Œå¡ä¹‹å¤–ï¼ŒMè¿™è¾¹è¿˜è¦ç–¯ç‹‚å¾€å¤–å–ï¼Œé¦–å…ˆå»å¤„ç†å™¨çš„ç§æœ‰é˜Ÿåˆ—é‡Œå–Gæ‰§è¡Œï¼Œå¦‚æœå–å®Œçš„è¯å°±å»å…¨å±€é˜Ÿåˆ—å–ï¼Œå¦‚æœå…¨å±€é˜Ÿåˆ—é‡Œä¹Ÿæ²¡æœ‰çš„è¯ï¼Œå°±å»å…¶ä»–å¤„ç†å™¨é˜Ÿåˆ—é‡Œå·ï¼Œå“‡ï¼Œè¿™ä¹ˆé¥¥æ¸´ï¼Œç®€ç›´æ˜¯æ¶é­”å•Šï¼

![](static/images/1718813abb679031.jpg)

å¦‚æœå“ªé‡Œéƒ½æ²¡æ‰¾åˆ°è¦æ‰§è¡Œçš„Gå‘¢ï¼Ÿé‚£Må°±ä¼šå› ä¸ºå¤ªå¤±æœ›å’ŒPæ–­å¼€å…³ç³»ï¼Œç„¶åå»ç¡è§‰ï¼ˆidleï¼‰äº†ã€‚

![](static/images/1718813afa26977e.jpg)

é‚£å¦‚æœä¸¤ä¸ªGoroutineæ­£åœ¨é€šè¿‡channelåšä¸€äº›æ©æ©çˆ±çˆ±çš„äº‹é˜»å¡ä½äº†æ€ä¹ˆåŠï¼Œéš¾é“Mè¦ç­‰ä»–ä»¬å®Œäº‹äº†å†ç»§ç»­æ‰§è¡Œï¼Ÿæ˜¾ç„¶ä¸ä¼šï¼ŒMå¹¶ä¸ç¨€ç½•è¿™å¯¹Goç”·å¥³ï¼Œè€Œä¼šè½¬èº«å»æ‰¾åˆ«çš„Gæ‰§è¡Œã€‚

![](static/images/1718813b326b7c73.jpg)


## ç³»ç»Ÿè°ƒç”¨

å¦‚æœGè¿›è¡Œäº†ç³»ç»Ÿè°ƒç”¨syscallï¼ŒMä¹Ÿä¼šè·Ÿç€è¿›å…¥ç³»ç»Ÿè°ƒç”¨çŠ¶æ€ï¼Œé‚£ä¹ˆè¿™ä¸ªPç•™åœ¨è¿™é‡Œå°±æµªè´¹äº†ï¼Œæ€ä¹ˆåŠå‘¢ï¼Ÿè¿™ç‚¹ç²¾å¦™ä¹‹å¤„åœ¨äºï¼ŒPä¸ä¼šå‚»å‚»çš„ç­‰å¾…Gå’ŒMç³»ç»Ÿè°ƒç”¨å®Œæˆï¼Œè€Œä¼šå»æ‰¾å…¶ä»–æ¯”è¾ƒé—²çš„Mæ‰§è¡Œå…¶ä»–çš„Gã€‚

![](static/images/1718813b73c47064.jpg)

å½“Gå®Œæˆäº†ç³»ç»Ÿè°ƒç”¨ï¼Œå› ä¸ºè¦ç»§ç»­å¾€ä¸‹æ‰§è¡Œï¼Œæ‰€ä»¥å¿…é¡»è¦å†æ‰¾ä¸€ä¸ªç©ºé—²çš„å¤„ç†å™¨å‘è½¦ã€‚

![](static/images/1718813bad18d998.jpg)

å¦‚æœæ²¡æœ‰ç©ºé—²çš„å¤„ç†å™¨äº†ï¼Œé‚£å°±åªèƒ½æŠŠGæ”¾å›å…¨å±€é˜Ÿåˆ—å½“ä¸­ç­‰å¾…åˆ†é…ã€‚

![](static/images/1718813bec3d6674.jpg)


## sysmon

sysmonæ˜¯æˆ‘ä»¬çš„ä¿æ´é˜¿å§¨ï¼Œå®ƒæ˜¯ä¸€ä¸ªMï¼Œåˆå«ç›‘æ§çº¿ç¨‹ï¼Œä¸éœ€è¦På°±å¯ä»¥ç‹¬ç«‹è¿è¡Œï¼Œæ¯20us~10msä¼šè¢«å”¤é†’ä¸€æ¬¡å‡ºæ¥æ‰“æ‰«å«ç”Ÿï¼Œä¸»è¦å·¥ä½œå°±æ˜¯å›æ”¶åƒåœ¾ã€å›æ”¶é•¿æ—¶é—´ç³»ç»Ÿè°ƒåº¦é˜»å¡çš„Pã€å‘é•¿æ—¶é—´è¿è¡Œçš„Gå‘å‡ºæŠ¢å è°ƒåº¦ç­‰ç­‰ã€‚

> [åŸæ–‡](https://github.com/lifei6671/interview-go/blob/master/base/go-gpm.md)